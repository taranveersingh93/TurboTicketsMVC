@using Microsoft.AspNetCore.Identity;
@using TurboTicketsMVC.Models.Enums;
@using TurboTicketsMVC.Services.Interfaces;
@using TurboTicketsMVC.Services;
@inject ITTNotificationService _notificationService;
@inject UserManager<TTUser> _UserManager;
@inject ITTFileService _fileService;

@{
    IEnumerable<Notification> myNotifications = await _notificationService.GetNotificationsByUserIdAsync(_UserManager.GetUserId(User));
    TTUser user = await _UserManager.GetUserAsync(User);
    bool unreadNotifications = false;
    if (myNotifications.Any(n => !n.HasBeenViewed))
    {
        unreadNotifications = true;
    }
    bool isAdmin = User.IsInRole("Admin");
    bool isPM = User.IsInRole("ProjectManager");
}

<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Gogi - Admin and Dashboard Template</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="~/gogi/assets/media/image/favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <!-- Main css -->
    <link rel="stylesheet" href="~/gogi/vendors/bundle.css" type="text/css">

    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Daterangepicker -->
    <link rel="stylesheet" href="../../vendors/datepicker/daterangepicker.css" type="text/css">

    <!-- App css -->
    <link rel="stylesheet" href="~/gogi/assets/css/app.css" type="text/css">
    <link rel="stylesheet" href="~/css/site.css" type="text/css">
    <link rel="stylesheet" href="~/css/site.css" type="text/css">


    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <partial name="_LogoutPartial" />

    <!-- Preloader -->
    <div class="preloader">
        <div class="preloader-icon"></div>
        <span>Loading...</span>
    </div>
    <!-- ./ Preloader -->
    <!-- Sidebar group -->
    <div class="sidebar-group">

        <!-- BEGIN: Settings -->
        <div class="sidebar" id="settings">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title d-flex justify-content-between">
                        Settings
                        <a class="btn-sidebar-close" href="#">
                            <i class="ti-close"></i>
                        </a>
                    </h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item pl-0 pr-0">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="customSwitch1" checked>
                                <label class="custom-control-label" for="customSwitch1">Allow notifications.</label>
                            </div>
                        </li>
                        <li class="list-group-item pl-0 pr-0">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="customSwitch2">
                                <label class="custom-control-label" for="customSwitch2">Hide user requests</label>
                            </div>
                        </li>
                        <li class="list-group-item pl-0 pr-0">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="customSwitch3" checked>
                                <label class="custom-control-label" for="customSwitch3">Speed up demands</label>
                            </div>
                        </li>
                        <li class="list-group-item pl-0 pr-0">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="customSwitch4" checked>
                                <label class="custom-control-label" for="customSwitch4">Hide menus</label>
                            </div>
                        </li>
                        <li class="list-group-item pl-0 pr-0">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="customSwitch5">
                                <label class="custom-control-label" for="customSwitch5">Remember next visits</label>
                            </div>
                        </li>
                        <li class="list-group-item pl-0 pr-0">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="customSwitch6">
                                <label class="custom-control-label" for="customSwitch6">
                                    Enable report
                                    generation.
                                </label>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- END: Settings -->
        <!-- BEGIN: Chat List -->
        <div class="sidebar" id="my-notifications">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title d-flex justify-content-between">
                        Notifications
                        <a class="btn-sidebar-close" href="#">
                            <i class="ti-close"></i>
                        </a>
                    </h6>
                    @if (myNotifications.Count() > 0)
                    {
                        <div class="list-group list-group-flush">
                            @foreach (Notification notification in myNotifications)
                            {
                                @if (notification.NotificationType == TTNotificationTypes.Project && notification.HasBeenViewed)
                                {
                                    <a asp-controller="Projects" asp-action="MarkRead" asp-route-id="@notification.Id" class="list-group-item d-flex p-2 align-items-start">
                                        <div class="pr-3">
                                            <span class="avatar">
                                                <img src="@_fileService.ConvertByteArrayToFile(notification.Sender.ImageFileData, notification.Sender.ImageFileType,DefaultImage.BTUserImage)"
                                                     class="rounded-circle"
                                                     alt="image">
                                            </span>
                                        </div>
                                        <div class="flex-grow- 1">
                                            <h6 class="mb-1">@notification.Title</h6>
                                            <span class="text-muted">
                                                By: @notification.Sender.FullName
                                            </span>
                                        </div>
                                        <div class="text-right ml-auto d-flex flex-column">
                                            <span class="small text-muted">@notification.CreatedDate.ToString("dd MMM yyyy")</span>
                                        </div>
                                    </a>
                                }
                                else if (notification.NotificationType == TTNotificationTypes.Project && !notification.HasBeenViewed)
                                {
                                    <a asp-controller="Projects" asp-action="MarkRead" asp-route-id="@notification.Id" class="list-group-item unread-notification d-flex p-2 align-items-start">
                                        <div class="pr-3">
                                            <span class="avatar avatar-state-primary">
                                                <img src="@_fileService.ConvertByteArrayToFile(notification.Sender.ImageFileData, notification.Sender.ImageFileType,DefaultImage.BTUserImage)"
                                                     class="rounded-circle"
                                                     alt="image">
                                            </span>
                                        </div>
                                        <div class="flex-grow- 1">
                                            <h6 class="mb-1 font-weight-bold">@notification.Title</h6>
                                            <span class="text-muted">
                                                By: @notification.Sender.FullName
                                            </span>
                                        </div>
                                        <div class="text-right ml-auto d-flex flex-column">
                                            <span class="small text-muted">@notification.CreatedDate.ToString("dd MMM yyyy")</span>
                                        </div>
                                    </a>
                                }
                                else if (notification.NotificationType == TTNotificationTypes.Ticket && notification.HasBeenViewed)
                                {
                                    <a asp-controller="Tickets" asp-action="MarkRead" asp-route-id="@notification.Id" class="list-group-item d-flex p-2 align-items-start">
                                        <div class="pr-3">
                                            <span class="avatar">
                                                <img src="@_fileService.ConvertByteArrayToFile(notification.Sender.ImageFileData, notification.Sender.ImageFileType,DefaultImage.BTUserImage)"
                                                     class="rounded-circle"
                                                     alt="image">
                                            </span>
                                        </div>
                                        <div class="flex-grow- 1">
                                            <h6 class="mb-1">@notification.Title</h6>
                                            <span class="text-muted">
                                                By: @notification.Sender.FullName
                                            </span>
                                        </div>
                                        <div class="text-right ml-auto d-flex flex-column">
                                            <span class="small text-muted">@notification.CreatedDate.ToString("dd MMM yyyy")</span>
                                        </div>
                                    </a>

                                }
                                else if (notification.NotificationType == TTNotificationTypes.Ticket && !notification.HasBeenViewed)
                                {
                                    <a asp-controller="Tickets" asp-action="MarkRead" asp-route-id="@notification.Id" class="list-group-item unread-notification d-flex p-2 align-items-start">
                                        <div class="pr-3">
                                            <span class="avatar avatar-state-primary">
                                                <img src="@_fileService.ConvertByteArrayToFile(notification.Sender.ImageFileData, notification.Sender.ImageFileType,DefaultImage.BTUserImage)"
                                                     class="rounded-circle"
                                                     alt="image">
                                            </span>
                                        </div>
                                        <div class="flex-grow- 1">
                                            <h6 class="mb-1 font-weight-bold">@notification.Title</h6>
                                            <span class="text-muted">
                                                By: @notification.Sender.FullName
                                            </span>
                                        </div>
                                        <div class="text-right ml-auto d-flex flex-column">
                                            <span class="small text-muted">@notification.CreatedDate.ToString("dd MMM yyyy")</span>
                                        </div>
                                    </a>
                                }
                            }

                        </div>

                    }
                    else
                    {
                        <h5 class="text-muted text-center">No notifications</h5>
                    }
                </div>
            </div>
        </div>
        <!-- END: Chat List -->

    </div>
    <!-- ./ Sidebar group -->
    <!-- Layout wrapper -->
    <div class="layout-wrapper">

        <!-- Header -->
        <div class="header d-print-none">
            <div class="header-container">
                <div class="header-left">
                    <div class="navigation-toggler">
                        <a href="#" data-action="navigation-toggler">
                            <i data-feather="menu"></i>
                        </a>
                    </div>

                    <div class="header-logo">
                        <a href=index.html>
                            <img class="logo" src="~/gogi/assets/media/image/logo.png" alt="logo">
                        </a>
                    </div>
                </div>

                <div class="header-body">
                    <div class="header-body-left"></div>

                    <div class="header-body-right">
                        <ul class="navbar-nav">
           
                            <li class="nav-item dropdown d-none d-md-block">
                                <a href="#" class="nav-link" title="Fullscreen" data-toggle="fullscreen">
                                    <i class="maximize" data-feather="maximize"></i>
                                    <i class="minimize" data-feather="minimize"></i>
                                </a>
                            </li>
                            @if (unreadNotifications)
                            {
                                <li class="nav-item dropdown">
                                    <a href="#" class="nav-link nav-link-notify" title="My Notifications" data-sidebar-target="#my-notifications">
                                        <i data-feather="bell"></i>
                                    </a>
                                </li>

                            }
                            else
                            {
                                <li class="nav-item dropdown">
                                    <a href="#" class="nav-link" title="My Notifications" data-sidebar-target="#my-notifications">
                                        <i data-feather="bell"></i>
                                    </a>
                                </li>

                            }



                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" title="User menu" data-toggle="dropdown">
                                    <figure class="avatar avatar-sm">
                                        <img src="@_fileService.ConvertByteArrayToFile(user.ImageFileData, user.ImageFileType, DefaultImage.BTUserImage)"
                                             class="rounded-circle"
                                             alt="avatar">
                                    </figure>
                                    <span class="ml-2 d-sm-inline d-none">@user.FullName</span>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-big">
                                    <div class="text-center py-4">
                                        <figure class="avatar avatar-lg mb-3 border-0">
                                            <img src="@_fileService.ConvertByteArrayToFile(user.ImageFileData, user.ImageFileType, DefaultImage.BTUserImage)"
                                                 class="rounded-circle" alt="image">
                                        </figure>
                                        <h5 class="text-center">@user.FullName</h5>
                                        <div class="mb-3 small text-center text-muted p-3 border-bottom-gray">@user.Email</div>
                                        <div class="d-flex flex-column align-items-center justify-content-between">
                                            <a asp-area="Identity" asp-page="/Account/Manage/Index" class="btn btn-outline-light btn-rounded d-flex justify-content-center mb-2" style="width:165px;">Edit Profile</a>

                                            <a asp-area="Identity" asp-page="/Account/Manage/ChangePassword" class="btn btn-outline-light btn-rounded d-flex justify-content-center mb-2" style="width:165px;">Change Password</a>
                                            <a href="javascript:document.getElementById('logoutForm').submit();" class="btn btn-outline-light btn-rounded d-flex justify-content-center mb-2" style="width:165px;">Logout</a>

                                        </div>

                                    </div>

                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <ul class="navbar-nav ml-auto">
                    <li class="nav-item header-toggler">
                        <a href="#" class="nav-link">
                            <i data-feather="arrow-down"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- ./ Header -->
        <!-- Content wrapper -->
        <div class="content-wrapper">
            <!-- begin::navigation -->
            <div class="navigation">
                <div class="navigation-header">
                    <span>Navigation</span>
                    <a href="#">
                        <i class="ti-close"></i>
                    </a>
                </div>
                <div class="navigation-menu-body">
                    <ul>
                        <li>
                            <a class="navigation-item" id="nav-Dashboard" asp-controller="Home" asp-action="Dashboard">
                                <span class="nav-link-icon">
                                    <i data-feather="pie-chart"></i>
                                </span>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a class="navigation-item" id="nav-Tickets" asp-controller="Tickets" asp-action="Index">
                                <span class="nav-link-icon">
                                    <i class="bi bi-file-earmark-check"></i>
                                </span>
                                <span>Tickets</span>
                            </a>
                        </li>
                        <li>
                            <a class="navigation-item" id="nav-Projects" asp-controller="Projects" asp-action="Index">
                                <span class="nav-link-icon">
                                    <i class="bi bi-folder"></i>
                                </span>
                                <span>Projects</span>
                            </a>
                        </li>
                        <li>
                            <a class="navigation-item" id="nav-Invites" asp-controller="Invites" asp-action="Index">
                                <span class="nav-link-icon">
                                    <i class="bi bi-envelope-plus"></i>
                                </span>
                                <span>Invites</span>
                            </a>
                        </li>
                        <li>
                            <a class="navigation-item" id="nav-Invites" asp-controller="Companies" asp-action="ManageUserRoles">
                                <span class="nav-link-icon">
                                    <i class="bi bi-sliders"></i>
                                </span>
                                <span>Manage Roles</span>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <span class="nav-link-icon">
                                    <i class="bi bi-plus-square"></i>
                                </span>
                                <span>Create</span>
                            </a>
                            <ul>
                                @if (isPM || isAdmin)
                                {
                                    <li>

                                        <a asp-controller="Projects" asp-action="Create">Project</a>
                                    </li>
                                }
                                <li>

                                    <a asp-controller="Tickets" asp-action="Create">Ticket</a>
                                </li>
                                @if (isAdmin)
                                {
                                    <li>

                                        <a asp-controller="Invites" asp-action="Create">Invite</a>
                                    </li>
                                }
                            </ul>
                        </li>
                        @if(isAdmin)
                        {
                                          
                        }
                    </ul>
                </div>
            </div>
            <!-- end::navigation -->
            <!-- Content body -->
            <div class="content-body">
                <!-- Content -->
                @RenderBody()
                <!-- ./ Content -->
                <!-- Footer -->
                <footer class="content-footer">
                    <div>© 2020 Gogi - <a href="http://laborasyon.com" target="_blank">Laborasyon</a></div>
                    <div>
                        <nav class="nav">
                            <a href="https://themeforest.net/licenses/standard" class="nav-link">Licenses</a>
                            <a href="#" class="nav-link">Change Log</a>
                            <a href="#" class="nav-link">Get Help</a>
                        </nav>
                    </div>
                </footer>
                <!-- ./ Footer -->
            </div>
            <!-- ./ Content body -->
        </div>
        <!-- ./ Content wrapper -->
    </div>
    <!-- ./ Layout wrapper -->
    <!-- Main scripts -->
    <script>
        const makeActive = () => {
            // Remove 'active' tag for all list items
            var listItems = document.querySelectorAll('.navigation-item');

            var pathname = window.location.pathname;

            for (let i = 0; i < listItems.length; i++) {
                listItems[i].classList.remove("active");

                if (!pathname.includes("Details") && listItems[i].href.includes(pathname)) {
                    listItems[i].classList.add('active')
                }
            }
        }
        window.addEventListener("load", makeActive);
    </script>
    <script src="~/gogi/vendors/bundle.js"></script>

    <!-- Apex chart -->
    <script src="~/gogi/vendors/charts/apex/apexcharts.min.js"></script>

    <!-- Daterangepicker -->
    <script src="~/gogi/vendors/datepicker/daterangepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- DataTable -->
    <script src="~/gogi/vendors/dataTable/datatables.min.js"></script>

    <!-- Dashboard scripts -->
    @* <script src="~/gogi/assets/js/examples/pages/dashboard.js"></script>  *@

    <!-- App scripts -->
    <script src="~/gogi/assets/js/app.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
